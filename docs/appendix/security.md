# Zero-OS Boot Security

In order to enforce security, we take advantage of SecureBoot enabled machines to
add security layer.

## SecureBoot

SecureBoot can restrict a machine to boot only signed operating system, with keys explicitly
added on the system. This will prevent unauthorized system to boot on a secure machine.

## Steps

To put SecureBoot in place, you need to do:
- Generate keys
- Install keys on the target machine
- Sign the kernel with your key
- Boot the kernel

You'll need `efitools` and `sbsigntool` packages.

# Building keys

Basicly, just generate keys using openssl (**PK** (primary key), **KEK** (key-exchange), **DB** (allowed boot)):
```bash
subject="Zero-OS Development"

openssl req -new -x509 -newkey rsa:2048 -subj "/CN=${subject} PK/" -keyout keys/PK.key -out keys/PK.crt -days 3650 -nodes -sha256
openssl req -new -x509 -newkey rsa:2048 -subj "/CN=${subject} KEK/" -keyout keys/KK.key -out keys/KK.crt -days 3650 -nodes -sha256
openssl req -new -x509 -newkey rsa:2048 -subj "/CN=${subject} DB/" -keyout keys/DB.key -out keys/DB.crt -days 3650 -nodes -sha256
```

Then set a `UUID` to your Primary Key (please avoid generic UUID):
```bash
cert-to-efi-sig-list -g $(uuidgen) PK.crt PK.esl
```

Build signed update file
```bash
sign-efi-sig-list -k PK.key -c PK.crt PK PK.esl PK.auth
```

# Build an automated locking program

In order to install certificates easily on the machine, you can generate a `LockDown.efi` program
with our keys integrated, this will speedup a lot locking mechanism.

To generate this, you needs to compile efitools with your keys.

Grab the source code:
```
git clone --depth=1 git://git.kernl.org/pub/scm/linux/kernel/git/jejb/efitools.git
```

Build a first time (some keys will be generated on this step):
```
cd efitools
make
```

Replace keys generated by `make` with our keys, and rebuild again:
```
cp ../keys/* .
make
```

Now you can use `LockDown.efi` (execute this from EFI) to install certificates.

# Sign the kernel

As soon as you have you efi-enabled (efi-stub) kernel image, just sign it:
```
sbsign --key keys/DB.key --cert keys/DB.crt --output kernel-signed.efi kernel.efi
```

That's it, you can now only boot this kernel on your machine !
